{% extends 'base/base.html' %}
{% load static %}

{% block custom_style %}
<style>
.sort-icons { font-size: 13px; margin-left: 4px; }
.sort-arrow { color: #888; text-decoration: none; margin: 0 1px; }
.sort-arrow.text-primary { color: #337ab7 !important; }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4" style="margin-top: 4rem; margin-bottom: 4rem;">
    <h2 class="mb-4">Dashboard de Administración</h2>
    <div class="row">
        <div class="col-xs-12 col-sm-2">
            <ul class="nav nav-pills nav-stacked" id="dashboardTabs">
                <li class="active"><a href="#resumen" data-toggle="tab">Resumen General</a></li>
                <li><a href="#productos" data-toggle="tab">Gestión de Productos</a></li>
                <li><a href="#pedidos" data-toggle="tab">Pedidos y Ventas</a></li>
                <li><a href="#clientes" data-toggle="tab">Clientes y Distribuidores</a></li>
                <li><a href="#logs" data-toggle="tab">Logs y Auditoría</a></li>
                <!-- <li><a href="#config" data-toggle="tab">Configuración</a></li> -->
            </ul>
        </div>
        <div class="col-xs-12 col-sm-10">
            <div class="tab-content" id="dashboardTabsContent">
                <div class="tab-pane fade in active" id="resumen">
                    <!-- Resumen General -->
                    <div class="row">
                        <div class="col-md-3 col-xs-6">
                            <div class="panel panel-info">
                                <div class="panel-heading"><b>Total Productos</b></div>
                                <div class="panel-body text-center">
                                    <span id="resumenTotalProductos" style="font-size:2em; font-weight:bold;">-</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 col-xs-6">
                            <div class="panel panel-success">
                                <div class="panel-heading"><b>Total Pedidos/Ventas</b></div>
                                <div class="panel-body text-center">
                                    <span id="resumenTotalPedidos" style="font-size:2em; font-weight:bold;">-</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 col-xs-6">
                            <div class="panel panel-warning">
                                <div class="panel-heading"><b>Total Clientes</b></div>
                                <div class="panel-body text-center">
                                    <span id="resumenTotalClientes" style="font-size:2em; font-weight:bold;">-</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 col-xs-6">
                            <div class="panel panel-danger">
                                <div class="panel-heading"><b>Stock Bajo (&lt; 10u)</b></div>
                                <div class="panel-body text-center">
                                    <span id="resumenStockBajo" style="font-size:2em; font-weight:bold;">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="tab-pane fade" id="productos">
                    <!--
                    Pestaña 'Gestión de Productos':
                    - Tabla con productos reales
                    - Inputs editables para precio y stock
                    - Select para estado
                    - Botón 'Editar' abre modal con datos del producto
                    - Modal Bootstrap para edición de producto
                    - Script jQuery para cargar datos en el modal
                    -->
                    <div class="clearfix mb-3">
                        <h4 class="pull-left">Gestión de Productos</h4>
                        <button class="btn btn-success pull-right" data-toggle="modal" data-target="#modalNuevoProducto">+ Nuevo Producto</button>
                    </div>
                    <div class="panel panel-default" style="margin-bottom:20px;">
                      <div class="panel-body">
                        <form id="formFiltroProductos" class="form-horizontal" method="get" style="margin-bottom:0;">
                          <div class="row">
                            <div class="col-sm-6 col-xs-12 form-group">
                              <input type="text" class="form-control" name="nombre" placeholder="Buscar por nombre" value="{{ request.GET.nombre|default:'' }}">
                            </div>
                            <div class="col-sm-3 col-xs-6 form-group">
                              <select class="form-control" name="estado">
                                <option value="">Estado</option>
                                <option value="activo" {% if request.GET.estado == 'activo' %}selected{% endif %}>Activo</option>
                                <option value="inactivo" {% if request.GET.estado == 'inactivo' %}selected{% endif %}>Inactivo</option>
                                <option value="descontinuado" {% if request.GET.estado == 'descontinuado' %}selected{% endif %}>Descontinuado</option>
                              </select>
                            </div>
                            <div class="col-sm-3 col-xs-6 form-group">
                              <select class="form-control" name="proveedor">
                                <option value="">Proveedor</option>
                                {% for proveedor in proveedores %}
                                  <option value="{{ proveedor }}" {% if request.GET.proveedor == proveedor %}selected{% endif %}>{{ proveedor }}</option>
                                {% endfor %}
                              </select>
                            </div>
                          </div>
                          <div class="row">
                            <div class="col-sm-4 col-xs-12 form-group">
                              <div class="input-group" style="width:100%;">
                                <input type="number" class="form-control" name="precio_min" placeholder="Precio mínimo" style="min-width:110px;" value="{{ request.GET.precio_min|default:'' }}">
                                <span class="input-group-addon">-</span>
                                <input type="number" class="form-control" name="precio_max" placeholder="Precio máximo" style="min-width:110px;" value="{{ request.GET.precio_max|default:'' }}">
                              </div>
                            </div>
                            <div class="col-sm-4 col-xs-12 form-group">
                              <div class="input-group" style="width:100%;">
                                <input type="number" class="form-control" name="stock_min" placeholder="Stock mínimo" style="min-width:110px;" value="{{ request.GET.stock_min|default:'' }}">
                                <span class="input-group-addon">-</span>
                                <input type="number" class="form-control" name="stock_max" placeholder="Stock máximo" style="min-width:110px;" value="{{ request.GET.stock_max|default:'' }}">
                              </div>
                            </div>
                            <div class="col-sm-4 col-xs-12 form-group">
                              <div class="input-group" style="width:100%;">
                                <input type="date" class="form-control" name="fecha_desde" value="{{ request.GET.fecha_desde|default:'' }}">
                                <span class="input-group-addon">-</span>
                                <input type="date" class="form-control" name="fecha_hasta" value="{{ request.GET.fecha_hasta|default:'' }}">
                              </div>
                            </div>
                          </div>
                          <div class="row">
                            <div class="col-sm-2 col-xs-6 form-group">
                              <button class="btn btn-primary btn-block" type="submit">Filtrar</button>
                            </div>
                            <div class="col-sm-2 col-xs-6 form-group">
                              <a href="?" class="btn btn-default btn-block" style="border:1px solid #ccc;">Borrar filtros</a>
                            </div>
                          </div>
                        </form>
                      </div>
                    </div>
                    <!--
                    Botones de acciones masivas:
                    - Activar seleccionados
                    - Inactivar seleccionados
                    - Descontinuar seleccionados
                    -->
                    <form id="formAccionMasiva">
                        <div class="mb-2" style="margin-bottom:10px;">
                            <button class="btn btn-primary btn-xs btn-accion-masiva" type="button" data-accion="activo" style="background-color:#337ab7; border-color:#2e6da4; color:white;">Activar seleccionados</button>
                            <button class="btn btn-warning btn-xs btn-accion-masiva" type="button" data-accion="inactivo">Desactivar seleccionados</button>
                            <button class="btn btn-info btn-xs btn-accion-masiva" type="button" data-accion="descontinuado" style="background-color:#5bc0de; border-color:#46b8da; color:white;">Descontinuar seleccionados</button>
                            <button class="btn btn-danger btn-xs btn-eliminar-masivo" type="button" style="margin-left:8px; background-color:#c9302c; border-color:#ac2925; color:white;">Eliminar seleccionados</button>
                        </div>
                        <div class="table-responsive" style="max-height: 70vh; overflow-x: auto; overflow-y: auto;">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th><input type="checkbox" id="checkAllProductos"></th>
                                        <th>
                                            <a href="?{% if request.GET %}{{ request.GET.urlencode|safe }}&{% endif %}sort=nombre&dir={% if request.GET.sort == 'nombre' and request.GET.dir == 'asc' %}desc{% else %}asc{% endif %}" class="sort-link" style="color:inherit; text-decoration:none;">
                                                Nombre
                                                <span class="sort-icons">
                                                    {% if request.GET.sort == 'nombre' and request.GET.dir == 'asc' %}
                                                        <a href="?{% for key, value in request.GET.items %}{% if key != 'sort' and key != 'dir' %}{{ key }}={{ value|urlencode }}&{% endif %}{% endfor %}" class="sort-arrow text-primary"><i class="fa fa-arrow-up"></i></a>
                                                    {% else %}
                                                        <a href="?{% if request.GET %}{{ request.GET.urlencode|safe }}&{% endif %}sort=nombre&dir=asc" class="sort-arrow"><i class="fa fa-arrow-up"></i></a>
                                                    {% endif %}
                                                    {% if request.GET.sort == 'nombre' and request.GET.dir == 'desc' %}
                                                        <a href="?{% for key, value in request.GET.items %}{% if key != 'sort' and key != 'dir' %}{{ key }}={{ value|urlencode }}&{% endif %}{% endfor %}" class="sort-arrow text-primary"><i class="fa fa-arrow-down"></i></a>
                                                    {% else %}
                                                        <a href="?{% if request.GET %}{{ request.GET.urlencode|safe }}&{% endif %}sort=nombre&dir=desc" class="sort-arrow"><i class="fa fa-arrow-down"></i></a>
                                                    {% endif %}
                                                </span>
                                            </a>
                                        </th>
                                        <th>Proveedor</th>
                                        <th>Precio
                                            <span class="sort-icons">
                                                {% if request.GET.sort == 'precio' and request.GET.dir == 'asc' %}
                                                    <a href="?{% for key, value in request.GET.items %}{% if key != 'sort' and key != 'dir' %}{{ key }}={{ value|urlencode }}&{% endif %}{% endfor %}" class="sort-arrow text-primary"><i class="fa fa-arrow-up"></i></a>
                                                {% else %}
                                                    <a href="?{% if request.GET %}{{ request.GET.urlencode|safe }}&{% endif %}sort=precio&dir=asc" class="sort-arrow {% if request.GET.sort == 'precio' and request.GET.dir == 'asc' %}text-primary{% endif %}"><i class="fa fa-arrow-up"></i></a>
                                                {% endif %}
                                                {% if request.GET.sort == 'precio' and request.GET.dir == 'desc' %}
                                                    <a href="?{% for key, value in request.GET.items %}{% if key != 'sort' and key != 'dir' %}{{ key }}={{ value|urlencode }}&{% endif %}{% endfor %}" class="sort-arrow text-primary"><i class="fa fa-arrow-down"></i></a>
                                                {% else %}
                                                    <a href="?{% if request.GET %}{{ request.GET.urlencode|safe }}&{% endif %}sort=precio&dir=desc" class="sort-arrow {% if request.GET.sort == 'precio' and request.GET.dir == 'desc' %}text-primary{% endif %}"><i class="fa fa-arrow-down"></i></a>
                                                {% endif %}
                                            </span>
                                        </th>
                                        <th>Stock
                                            <span class="sort-icons">
                                                {% if request.GET.sort == 'stock' and request.GET.dir == 'asc' %}
                                                    <a href="?{% for key, value in request.GET.items %}{% if key != 'sort' and key != 'dir' %}{{ key }}={{ value|urlencode }}&{% endif %}{% endfor %}" class="sort-arrow text-primary"><i class="fa fa-arrow-up"></i></a>
                                                {% else %}
                                                    <a href="?{% if request.GET %}{{ request.GET.urlencode|safe }}&{% endif %}sort=stock&dir=asc" class="sort-arrow {% if request.GET.sort == 'stock' and request.GET.dir == 'asc' %}text-primary{% endif %}"><i class="fa fa-arrow-up"></i></a>
                                                {% endif %}
                                                {% if request.GET.sort == 'stock' and request.GET.dir == 'desc' %}
                                                    <a href="?{% for key, value in request.GET.items %}{% if key != 'sort' and key != 'dir' %}{{ key }}={{ value|urlencode }}&{% endif %}{% endfor %}" class="sort-arrow text-primary"><i class="fa fa-arrow-down"></i></a>
                                                {% else %}
                                                    <a href="?{% if request.GET %}{{ request.GET.urlencode|safe }}&{% endif %}sort=stock&dir=desc" class="sort-arrow {% if request.GET.sort == 'stock' and request.GET.dir == 'desc' %}text-primary{% endif %}"><i class="fa fa-arrow-down"></i></a>
                                                {% endif %}
                                            </span>
                                        </th>
                                        <th>Estado
                                            <span class="sort-icons">
                                                {% if request.GET.sort == 'estado' and request.GET.dir == 'asc' %}
                                                    <a href="?{% for key, value in request.GET.items %}{% if key != 'sort' and key != 'dir' %}{{ key }}={{ value|urlencode }}&{% endif %}{% endfor %}" class="sort-arrow text-primary"><i class="fa fa-arrow-up"></i></a>
                                                {% else %}
                                                    <a href="?{% if request.GET %}{{ request.GET.urlencode|safe }}&{% endif %}sort=estado&dir=asc" class="sort-arrow {% if request.GET.sort == 'estado' and request.GET.dir == 'asc' %}text-primary{% endif %}"><i class="fa fa-arrow-up"></i></a>
                                                {% endif %}
                                                {% if request.GET.sort == 'estado' and request.GET.dir == 'desc' %}
                                                    <a href="?{% for key, value in request.GET.items %}{% if key != 'sort' and key != 'dir' %}{{ key }}={{ value|urlencode }}&{% endif %}{% endfor %}" class="sort-arrow text-primary"><i class="fa fa-arrow-down"></i></a>
                                                {% else %}
                                                    <a href="?{% if request.GET %}{{ request.GET.urlencode|safe }}&{% endif %}sort=estado&dir=desc" class="sort-arrow {% if request.GET.sort == 'estado' and request.GET.dir == 'desc' %}text-primary{% endif %}"><i class="fa fa-arrow-down"></i></a>
                                                {% endif %}
                                            </span>
                                        </th>
                                        <th>Fecha Creación
                                            <span class="sort-icons">
                                                {% if request.GET.sort == 'fecha_creacion' and request.GET.dir == 'asc' %}
                                                    <a href="?{% for key, value in request.GET.items %}{% if key != 'sort' and key != 'dir' %}{{ key }}={{ value|urlencode }}&{% endif %}{% endfor %}" class="sort-arrow text-primary"><i class="fa fa-arrow-up"></i></a>
                                                {% else %}
                                                    <a href="?{% if request.GET %}{{ request.GET.urlencode|safe }}&{% endif %}sort=fecha_creacion&dir=asc" class="sort-arrow {% if request.GET.sort == 'fecha_creacion' and request.GET.dir == 'asc' %}text-primary{% endif %}"><i class="fa fa-arrow-up"></i></a>
                                                {% endif %}
                                                {% if request.GET.sort == 'fecha_creacion' and request.GET.dir == 'desc' %}
                                                    <a href="?{% for key, value in request.GET.items %}{% if key != 'sort' and key != 'dir' %}{{ key }}={{ value|urlencode }}&{% endif %}{% endfor %}" class="sort-arrow text-primary"><i class="fa fa-arrow-down"></i></a>
                                                {% else %}
                                                    <a href="?{% if request.GET %}{{ request.GET.urlencode|safe }}&{% endif %}sort=fecha_creacion&dir=desc" class="sort-arrow {% if request.GET.sort == 'fecha_creacion' and request.GET.dir == 'desc' %}text-primary{% endif %}"><i class="fa fa-arrow-down"></i></a>
                                                {% endif %}
                                            </span>
                                        </th>
                                        <th>Imagen</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for producto in productos %}
                                    <tr data-id="{{ producto.id }}">
                                        <td><input type="checkbox" name="seleccionados" value="{{ producto.id }}"></td>
                                        <td>{{ producto.nombre }}</td>
                                        <td>{{ producto.proveedor }}</td>
                                        <td><input type="number" class="form-control input-cambio-rapido" value="{{ producto.precio }}" name="precio_{{ producto.id }}" data-campo="precio" style="min-width:90px; width:110px; text-align:right;"></td>
                                        <td>
                                            <input type="number" class="form-control input-cambio-rapido"
                                                value="{{ producto.stock }}"
                                                name="stock_{{ producto.id }}" data-campo="stock"
                                                style="
                                                    min-width:90px; width:110px; text-align:right;
                                                    {% if producto.stock < 10 %}background-color:#f2dede; color:#a94442;{% elif producto.stock <= 20 %}background-color:#fcf8e3; color:#8a6d3b;{% else %}background-color:#dff0d8; color:#3c763d;{% endif %}"
                                            >
                                        </td>
                                        <td>
                                            <select class="form-control input-cambio-rapido" name="estado_{{ producto.id }}" data-campo="estado" style="min-width:120px; width:130px;">
                                                <option value="activo" {% if producto.estado == 'activo' %}selected{% endif %}>Activo</option>
                                                <option value="inactivo" {% if producto.estado == 'inactivo' %}selected{% endif %}>Inactivo</option>
                                                <option value="descontinuado" {% if producto.estado == 'descontinuado' %}selected{% endif %}>Descontinuado</option>
                                            </select>
                                        </td>
                                        <td style="white-space:nowrap; font-size:12px; color:#888; vertical-align:middle;">{{ producto.fecha_creacion|date:'Y-m-d' }}</td>
                                        <td style="text-align:center; vertical-align:middle;">
                                            {% if producto.imagen %}
                                                <img src="{{ producto.imagen.url }}" alt="Imagen producto" style="max-width:48px; max-height:48px; border-radius:6px; border:1px solid #ddd; background:#fafafa;">
                                            {% else %}
                                                <img src="{% static 'imgProductos/placeholder.png' %}" alt="Sin imagen" style="max-width:48px; max-height:48px; border-radius:6px; border:1px solid #ddd; background:#fafafa;">
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group-vertical" style="width:100%;">
                                                <button class="btn btn-info btn-xs btn-editar-producto" type="button" data-id="{{ producto.id }}"
                                                    data-nombre="{{ producto.nombre }}"
                                                    data-proveedor="{{ producto.proveedor }}"
                                                    data-precio="{{ producto.precio }}"
                                                    data-stock="{{ producto.stock }}"
                                                    data-estado="{{ producto.estado }}"
                                                    data-imagen="{% if producto.imagen %}{{ producto.imagen.url }}{% else %}{% static 'imgProductos/placeholder.png' %}{% endif %}"
                                                    style="width:100%; margin-bottom:4px;"
                                                >Editar</button>
                                                <button class="btn btn-danger btn-xs btn-eliminar-producto" type="button" style="width:100%; margin-bottom:4px;">Eliminar</button>
                                                <button class="btn btn-success btn-xs btn-confirmar-cambio" type="button" style="display:none; width:100%;">Confirmar</button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr><td colspan="9">No hay productos registrados.</td></tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </form>
                    <!-- Modal Edición Producto -->
                    <div class="modal fade" id="modalEditarProducto" tabindex="-1" role="dialog" aria-labelledby="modalEditarProductoLabel">
                      <div class="modal-dialog" role="document">
                        <div class="modal-content">
                          <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                            <h4 class="modal-title" id="modalEditarProductoLabel">Editar Producto</h4>
                          </div>
                          <form id="formEditarProducto" method="post" enctype="multipart/form-data">
                            <div class="modal-body">
                                {% csrf_token %}
                                <input type="hidden" name="id" id="editProductoId">
                                <div class="form-group">
                                    <label for="editNombre">Nombre</label>
                                    <input type="text" class="form-control" name="nombre" id="editNombre" required>
                                </div>
                                <div class="form-group">
                                    <label for="editProveedor">Proveedor</label>
                                    <input type="text" class="form-control" name="proveedor" id="editProveedor">
                                </div>
                                <div class="form-group">
                                    <label for="editPrecio">Precio</label>
                                    <input type="number" class="form-control" name="precio" id="editPrecio" required>
                                </div>
                                <div class="form-group">
                                    <label for="editStock">Stock</label>
                                    <input type="number" class="form-control" name="stock" id="editStock" required>
                                </div>
                                <div class="form-group">
                                    <label for="editEstado">Estado</label>
                                    <select class="form-control" name="estado" id="editEstado">
                                        <option value="activo">Activo</option>
                                        <option value="inactivo">Inactivo</option>
                                        <option value="descontinuado">Descontinuado</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Imagen actual</label><br>
                                    <img id="editImagenPreview" src="{% static 'imgProductos/placeholder.png' %}" alt="Imagen actual" style="max-width:64px; max-height:64px; border-radius:6px; border:1px solid #ddd; background:#fafafa; margin-bottom:8px;">
                                </div>
                                <div class="form-group">
                                    <label for="editImagen">Cambiar imagen</label>
                                    <input type="file" class="form-control" name="imagen" id="editImagen" accept="image/jpeg,image/png,image/jpg,image/webp">
                                    <small class="text-muted">Formatos permitidos: JPG, PNG, WEBP.</small>
                                </div>
                                <div id="editarProductoError" class="alert alert-danger" style="display:none;"></div>
                            </div>
                            <div class="modal-footer">
                              <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
                              <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                            </div>
                          </form>
                        </div>
                      </div>
                    </div>
                    <!-- Modal Confirmar Eliminación -->
                    <div class="modal fade" id="modalConfirmarEliminar" tabindex="-1" role="dialog" aria-labelledby="modalConfirmarEliminarLabel">
                      <div class="modal-dialog" role="document">
                        <div class="modal-content" style="border:2px solid #d9534f;">
                          <div class="modal-header" style="background:#d9534f; color:white;">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="color:white;"><span aria-hidden="true">&times;</span></button>
                            <h4 class="modal-title" id="modalConfirmarEliminarLabel"><i class="fa fa-exclamation-triangle"></i> Confirmar eliminación</h4>
                          </div>
                          <div class="modal-body" style="color:#a94442; font-size:16px;">
                            ¿Está seguro que desea eliminar el producto <b id="nombreProductoEliminar"></b>?
                            <br><span style="font-size:13px; color:#a94442;">Esta acción no se puede deshacer.</span>
                          </div>
                          <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
                            <button type="button" class="btn btn-danger" id="btnConfirmarEliminarProducto">Eliminar</button>
                          </div>
                        </div>
                      </div>
                    </div>
                    <!-- Modal Nuevo Producto -->
                    <div class="modal fade" id="modalNuevoProducto" tabindex="-1" role="dialog" aria-labelledby="modalNuevoProductoLabel">
                      <div class="modal-dialog" role="document">
                        <div class="modal-content">
                          <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                            <h4 class="modal-title" id="modalNuevoProductoLabel">Nuevo Producto</h4>
                          </div>
                          <form id="formNuevoProducto" method="post">
                            <div class="modal-body">
                                {% csrf_token %}
                                <div class="form-group">
                                    <label for="nuevoNombre">Nombre</label>
                                    <input type="text" class="form-control" name="nombre" id="nuevoNombre" required>
                                </div>
                                <div class="form-group">
                                    <label for="nuevoProveedor">Proveedor</label>
                                    <input type="text" class="form-control" name="proveedor" id="nuevoProveedor">
                                </div>
                                <div class="form-group">
                                    <label for="nuevoPrecio">Precio</label>
                                    <input type="number" class="form-control" name="precio" id="nuevoPrecio" required>
                                </div>
                                <div class="form-group">
                                    <label for="nuevoStock">Stock</label>
                                    <input type="number" class="form-control" name="stock" id="nuevoStock" required>
                                </div>
                                <div class="form-group">
                                    <label for="nuevoEstado">Estado</label>
                                    <select class="form-control" name="estado" id="nuevoEstado">
                                        <option value="activo">Activo</option>
                                        <option value="inactivo" selected>Inactivo</option>
                                        <option value="descontinuado">Descontinuado</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="nuevoDescripcion">Descripción</label>
                                    <textarea class="form-control" name="descripcion" id="nuevoDescripcion" rows="3" required></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="nuevoImagen">Imagen</label>
                                    <input type="file" class="form-control" name="imagen" id="nuevoImagen" accept="image/jpeg,image/png,image/jpg,image/webp">
                                    <small class="text-muted">Formatos permitidos: JPG, PNG, WEBP.</small>
                                </div>
                                <div id="nuevoProductoError" class="alert alert-danger" style="display:none;"></div>
                            </div>
                            <div class="modal-footer">
                              <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
                              <button type="submit" class="btn btn-success">Crear Producto</button>
                            </div>
                          </form>
                        </div>
                      </div>
                    </div>
                </div>
                <div class="tab-pane fade" id="pedidos">
                    <!-- Pedidos y Ventas -->
                    <div class="clearfix mb-3">
                        <h4 class="pull-left">Pedidos y Ventas</h4>
                        <!-- Botón eliminado: el alta será automática -->
                    </div>
                    <div class="panel panel-default" style="margin-bottom:20px;">
                        <div class="panel-body">
                            <form id="formFiltroPedidos" class="form-inline" style="margin-bottom:10px;" method="get" action="">
                                <div class="form-group">
                                    <input type="text" class="form-control" name="cliente" placeholder="Cliente" style="min-width:120px;" value="{{ request.GET.cliente|default:'' }}">
                                </div>
                                <div class="form-group">
                                    <select class="form-control" name="estado">
                                        <option value="">Estado</option>
                                        <option value="pendiente" {% if request.GET.estado == 'pendiente' %}selected{% endif %}>Pendiente</option>
                                        <option value="procesado" {% if request.GET.estado == 'procesado' %}selected{% endif %}>Procesado</option>
                                        <option value="entregado" {% if request.GET.estado == 'entregado' %}selected{% endif %}>Entregado</option>
                                        <option value="cancelado" {% if request.GET.estado == 'cancelado' %}selected{% endif %}>Cancelado</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <input type="date" class="form-control" name="fecha_desde" value="{{ request.GET.fecha_desde|default:'' }}">
                                </div>
                                <div class="form-group">
                                    <input type="date" class="form-control" name="fecha_hasta" value="{{ request.GET.fecha_hasta|default:'' }}">
                                </div>
                                <button class="btn btn-primary" type="submit">Filtrar</button>
                                <a href="?" class="btn btn-default" id="btnLimpiarFiltroPedidos">Borrar filtros</a>
                            </form>
                            <div id="pedidosLoader" style="display:none; text-align:center; padding:20px;">
                                <i class="fa fa-spinner fa-spin fa-2x"></i> Cargando pedidos...
                            </div>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover" id="tablaPedidosVentas">
                                    <thead>
                                        <tr>
                                            <th>Fecha</th>
                                            <th>Cliente</th>
                                            <th>Tipo</th>
                                            <th>Productos</th>
                                            <th>Total</th>
                                            <th>Estado</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% if pedidos %}
                                            {% for pedido in pedidos %}
                                            <tr>
                                                <td>{{ pedido.fecha|date:'Y-m-d H:i' }}</td>
                                                <td>{{ pedido.cliente }}</td>
                                                <td>{{ pedido.tipo|title }}</td>
                                                <td>
                                                    <ul style="margin:0; padding-left:18px;">
                                                        {% for item in pedido.items %}
                                                        <li>{{ item.producto }} x{{ item.cantidad }} <span style="color:#888;">@ ${{ item.precio_unitario|floatformat:0 }}</span></li>
                                                        {% endfor %}
                                                    </ul>
                                                </td>
                                                <td>${{ pedido.total|floatformat:0 }}</td>
                                                <td>{{ pedido.estado|title }}</td>
                                                <td>
                                                    <button class="btn btn-success btn-xs btn-terminar-pedido" data-id="{{ pedido.id }}" title="Terminar pedido"><i class="fa fa-check"></i></button>
                                                    <button class="btn btn-danger btn-xs btn-eliminar-pedido" data-id="{{ pedido.id }}" title="Eliminar pedido"><i class="fa fa-trash"></i></button>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        {% else %}
                                            <tr id="pedidosVacioRow"><td colspan="7" style="text-align:center; color:#888;">No hay pedidos ni ventas.</td></tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <!-- Modal Nuevo Pedido/Venta (estructura básica, se completa luego) -->
                    <div class="modal fade" id="modalNuevoPedidoVenta" tabindex="-1" role="dialog" aria-labelledby="modalNuevoPedidoVentaLabel">
                      <div class="modal-dialog" role="document">
                        <div class="modal-content">
                          <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                            <h4 class="modal-title" id="modalNuevoPedidoVentaLabel">Nuevo Pedido / Venta</h4>
                          </div>
                          <form id="formNuevoPedidoVenta" method="post">
                            <div class="modal-body">
                                <!-- Aquí irán los campos del formulario -->
                                <div class="alert alert-info">Funcionalidad en desarrollo.</div>
                            </div>
                            <div class="modal-footer">
                              <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
                              <button type="submit" class="btn btn-success" disabled>Guardar</button>
                            </div>
                          </form>
                        </div>
                      </div>
                    </div>
                </div>
                <div class="tab-pane fade" id="clientes">
                    <!-- Clientes y Distribuidores -->
                    <div class="clearfix mb-3">
                        <h4 class="pull-left">Clientes y Distribuidores</h4>
                        <button class="btn btn-success pull-right" id="btnNuevoClienteDistribuidor" data-toggle="modal" data-target="#modalNuevoClienteDistribuidor">+ Nuevo</button>
                    </div>
                    <div class="panel panel-default" style="margin-bottom:20px;">
                        <div class="panel-body">
                            <form id="formFiltroClientes" class="form-inline" style="margin-bottom:10px;">
                                <div class="form-group">
                                    <select class="form-control" name="tipo">
                                        <option value="">Tipo</option>
                                        <option value="cliente">Cliente</option>
                                        <option value="distribuidor">Distribuidor</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <input type="text" class="form-control" name="nombre" placeholder="Nombre" style="min-width:120px;">
                                </div>
                                <div class="form-group">
                                    <select class="form-control" name="activos">
                                        <option value="1">Solo activos</option>
                                        <option value="0">Todos</option>
                                    </select>
                                </div>
                                <button class="btn btn-primary" type="submit">Filtrar</button>
                                <button class="btn btn-default" type="button" id="btnLimpiarFiltroClientes">Borrar filtros</button>
                            </form>
                            <div id="clientesLoader" style="display:none; text-align:center; padding:20px;">
                                <i class="fa fa-spinner fa-spin fa-2x"></i> Cargando clientes...
                            </div>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover" id="tablaClientesDistribuidores">
                                    <thead>
                                        <tr>
                                            <th>Tipo</th>
                                            <th>Nombre</th>
                                            <th>RUT</th>
                                            <th>Email</th>
                                            <th>Teléfono</th>
                                            <th>Dirección</th>
                                            <th>Fecha creación</th>
                                            <th>Activo</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for cliente in clientes %}
                                        <tr data-id="{{ cliente.id }}">
                                            <td>{{ cliente.tipo|title }}</td>
                                            <td>{{ cliente.nombre }}</td>
                                            <td>{{ cliente.rut }}</td>
                                            <td>{{ cliente.email }}</td>
                                            <td>{{ cliente.telefono }}</td>
                                            <td>{{ cliente.direccion }}</td>
                                            <td>{{ cliente.fecha_creacion|date:'Y-m-d' }}</td>
                                            <td>{% if cliente.activo %}<span class="label label-success">Sí</span>{% else %}<span class="label label-default">No</span>{% endif %}</td>
                                            <td>
                                                <div class="btn-group-vertical" style="width:100%;">
                                                    <button class="btn btn-info btn-xs btn-editar-cliente" type="button" data-id="{{ cliente.id }}" style="width:100%; margin-bottom:4px;">Editar</button>
                                                    <button class="btn btn-danger btn-xs btn-eliminar-cliente" type="button" data-id="{{ cliente.id }}" style="width:100%;">Eliminar</button>
                                                </div>
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr id="clientesVacioRow"><td colspan="9" style="text-align:center; color:#888;">No hay clientes ni distribuidores.</td></tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <!-- Modal Nuevo Cliente/Distribuidor -->
                    <div class="modal fade" id="modalNuevoClienteDistribuidor" tabindex="-1" role="dialog" aria-labelledby="modalNuevoClienteDistribuidorLabel">
                      <div class="modal-dialog" role="document">
                        <div class="modal-content">
                          <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                            <h4 class="modal-title" id="modalNuevoClienteDistribuidorLabel">Nuevo Cliente / Distribuidor</h4>
                          </div>
                          <form id="formNuevoClienteDistribuidor" method="post">
                            <div class="modal-body">
                                <div class="form-group">
                                    <label for="nuevoTipo">Tipo</label>
                                    <select class="form-control" name="tipo" id="nuevoTipo">
                                        <option value="cliente">Cliente</option>
                                        <option value="distribuidor">Distribuidor</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="nuevoNombreCliente">Nombre</label>
                                    <input type="text" class="form-control" name="nombre" id="nuevoNombreCliente" required>
                                </div>
                                <div class="form-group">
                                    <label for="nuevoRut">RUT</label>
                                    <input type="text" class="form-control" name="rut" id="nuevoRut">
                                </div>
                                <div class="form-group">
                                    <label for="nuevoEmail">Email</label>
                                    <input type="email" class="form-control" name="email" id="nuevoEmail">
                                </div>
                                <div class="form-group">
                                    <label for="nuevoTelefono">Teléfono</label>
                                    <input type="text" class="form-control" name="telefono" id="nuevoTelefono">
                                </div>
                                <div class="form-group">
                                    <label for="nuevoDireccion">Dirección</label>
                                    <input type="text" class="form-control" name="direccion" id="nuevoDireccion">
                                </div>
                                <!-- NUEVO: Checkbox para crear usuario distribuidor -->
                                <div class="form-group" id="grupoCrearUsuarioDistribuidor" style="display:none;">
                                    <div class="checkbox">
                                      <label>
                                        <input type="checkbox" name="crear_usuario_distribuidor" id="crearUsuarioDistribuidor"> Crear usuario distribuidor (acceso al portal mayorista)
                                      </label>
                                    </div>
                                </div>
                                <!-- NUEVO: Campo contraseña para usuario distribuidor -->
                                <div class="form-group" id="grupoPasswordDistribuidor" style="display:none;">
                                    <label for="nuevoPasswordDistribuidor">Contraseña de acceso</label>
                                    <input type="password" class="form-control" name="password_distribuidor" id="nuevoPasswordDistribuidor" minlength="6" autocomplete="new-password">
                                    <small class="text-muted">Mínimo 6 caracteres.</small>
                                </div>
                                <div id="nuevoClienteError" class="alert alert-danger" style="display:none;"></div>
                            </div>
                            <div class="modal-footer">
                              <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
                              <button type="submit" class="btn btn-success">Crear</button>
                            </div>
                          </form>
                        </div>
                      </div>
                    </div>
                </div>
                <div class="tab-pane fade" id="logs">
                    <!-- Logs y Auditoría -->
                    <div class="clearfix mb-3">
                        <h4 class="pull-left">Logs y Auditoría</h4>
                    </div>
                    <div class="panel panel-default" style="margin-bottom:20px;">
                        <div class="panel-body">
                            <form id="formFiltroLogs" class="form-inline" style="margin-bottom:10px;">
                                <div class="form-group">
                                    <input type="text" class="form-control" name="usuario" placeholder="Usuario" style="min-width:120px;">
                                </div>
                                <div class="form-group">
                                    <select class="form-control" name="accion">
                                        <option value="">Acción</option>
                                        <option value="crear">Crear</option>
                                        <option value="editar">Editar</option>
                                        <option value="eliminar">Eliminar</option>
                                        <option value="login">Login</option>
                                        <option value="logout">Logout</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <input type="date" class="form-control" name="fecha_desde">
                                </div>
                                <div class="form-group">
                                    <input type="date" class="form-control" name="fecha_hasta">
                                </div>
                                <button class="btn btn-primary" type="submit">Filtrar</button>
                                <button class="btn btn-default" type="button" id="btnLimpiarFiltroLogs">Borrar filtros</button>
                            </form>
                            <div id="logsLoader" style="display:none; text-align:center; padding:20px;">
                                <i class="fa fa-spinner fa-spin fa-2x"></i> Cargando logs...
                            </div>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover" id="tablaLogsAuditoria">
                                    <thead>
                                        <tr>
                                            <th>Fecha/Hora</th>
                                            <th>Usuario</th>
                                            <th>Acción</th>
                                            <th>Módulo/Modelo</th>
                                            <th>Detalles</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr id="logsVacioRow"><td colspan="5" style="text-align:center; color:#888;">No hay registros de auditoría.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- <div class="tab-pane fade" id="config">
                    <!-- Configuración -->
                <!-- </div> -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block custom_script %}
<script src="{% static 'js/dashboard.js' %}"></script>
{% endblock %}
<!-- Modal Detalle Inventario -->
<div class="modal fade" id="modalDetalleInventario" tabindex="-1" role="dialog" aria-labelledby="modalDetalleInventarioLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="modalDetalleInventarioLabel">Detalle de Producto</h4>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-xs-4 text-center">
            <img id="detalleInventarioImagen" src="" alt="Imagen producto" style="max-width:80px; max-height:80px; border-radius:8px; border:1px solid #ddd; background:#fafafa;">
          </div>
          <div class="col-xs-8">
            <h4 id="detalleInventarioNombre" style="margin-top:0;"></h4>
            <p>Stock actual: <span id="detalleInventarioStock" class="label"></span></p>
            <p>Estado: <span id="detalleInventarioEstado" class="label"></span></p>
            <p>Proveedor: <span id="detalleInventarioProveedor"></span></p>
          </div>
        </div>
        <hr>
        <div class="row">
          <div class="col-xs-12">
            <button class="btn btn-default" id="btnContactarProveedor" style="margin-bottom:8px; width:100%;"><i class="fa fa-envelope"></i> Contactar al proveedor</button>
            <button class="btn btn-primary" id="btnPedirStock" style="width:100%;"><i class="fa fa-truck"></i> Pedir más stock</button>
            <form id="formPedirStock" style="display:none; margin-top:12px;">
              <div class="form-group">
                <label for="inputCantidadStock">Cantidad a pedir</label>
                <input type="number" class="form-control" id="inputCantidadStock" min="1" required>
              </div>
              <div class="form-group">
                <label for="inputComentarioStock">Comentario</label>
                <textarea class="form-control" id="inputComentarioStock" rows="2" placeholder="Opcional"></textarea>
              </div>
              <button type="submit" class="btn btn-success btn-block">Enviar solicitud</button>
              <div id="msgPedirStock" class="alert alert-success" style="display:none; margin-top:10px;"></div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // ...existing code...
    document.querySelectorAll('.btn-terminar-pedido').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            var pedidoId = this.getAttribute('data-id');
            if (!confirm('¿Marcar este pedido como ENTREGADO?')) return;
            fetch('/api/pedido/terminar/' + pedidoId + '/', {
                method: 'POST',
                headers: { 'X-CSRFToken': '{{ csrf_token }}' }
            })
            .then(response => response.json())
            .then(data => {
                if(data.status === 'ok') {
                    location.reload();
                } else {
                    alert('Error al terminar el pedido.');
                }
            });
        });
    });
    document.querySelectorAll('.btn-eliminar-pedido').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            var pedidoId = this.getAttribute('data-id');
            if (!confirm('¿Eliminar este pedido? Esta acción no se puede deshacer.')) return;
            fetch('/api/pedido/eliminar/' + pedidoId + '/', {
                method: 'POST',
                headers: { 'X-CSRFToken': '{{ csrf_token }}' }
            })
            .then(response => response.json())
            .then(data => {
                if(data.status === 'ok') {
                    location.reload();
                } else {
                    alert('Error al eliminar el pedido.');
                }
            });
        });
    });
    // Debug: mostrar en consola si los botones existen
    $(document).ready(function() {
        var terminarBtns = $('.btn-terminar-pedido');
        var eliminarBtns = $('.btn-eliminar-pedido');
        console.log('Botones terminar:', terminarBtns.length, 'Botones eliminar:', eliminarBtns.length);
        if (terminarBtns.length === 0 && eliminarBtns.length === 0) {
            console.warn('No se encontraron botones de acción en la tabla de pedidos.');
        }
    });
});
</script>
<!-- Modal Confirmar Eliminación Cliente/Distribuidor -->
<div class="modal fade" id="modalConfirmarEliminarCliente" tabindex="-1" role="dialog" aria-labelledby="modalConfirmarEliminarClienteLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content" style="border:2px solid #d9534f;">
      <div class="modal-header" style="background:#d9534f; color:white;">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="color:white;"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="modalConfirmarEliminarClienteLabel"><i class="fa fa-exclamation-triangle"></i> Confirmar eliminación</h4>
      </div>
      <div class="modal-body" style="color:#a94442; font-size:16px;">
        ¿Está seguro que desea eliminar el cliente/distribuidor <b id="nombreClienteEliminar"></b>?
        <br><span style="font-size:13px; color:#a94442;">Esta acción no se puede deshacer.</span>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-danger" id="btnConfirmarEliminarCliente">Eliminar</button>
      </div>
    </div>
  </div>
</div>
<script>
$(function() {
  // Eliminar cliente/distribuidor
  var clienteIdEliminar = null;
  var clienteNombreEliminar = '';
  $(document).on('click', '.btn-eliminar-cliente', function() {
    var row = $(this).closest('tr');
    clienteIdEliminar = row.data('id');
    clienteNombreEliminar = row.find('td').eq(1).text();
    $('#nombreClienteEliminar').text(clienteNombreEliminar);
    $('#modalConfirmarEliminarCliente').modal('show');
  });
  $('#btnConfirmarEliminarCliente').off('click').on('click', function() {
    if (!clienteIdEliminar) return;
    var btn = $(this);
    btn.prop('disabled', true).text('Eliminando...');
    $.ajax({
      url: '/api/eliminar_cliente/' + clienteIdEliminar + '/',
      type: 'POST',
      data: {csrfmiddlewaretoken: '{{ csrf_token }}'},
      success: function(resp) {
        $('#modalConfirmarEliminarCliente').modal('hide');
        $('tr[data-id="'+clienteIdEliminar+'"]', '#tablaClientesDistribuidores').fadeOut(300, function() { $(this).remove(); });
        clienteIdEliminar = null;
        btn.prop('disabled', false).text('Eliminar');
      },
      error: function(xhr) {
        alert('Error al eliminar.');
        btn.prop('disabled', false).text('Eliminar');
      }
    });
  });
});
</script>
